# E-commerce CVR预测模型

本项目实现了一个用于电商场景下的用户转化率（CVR）预测模型，基于阿里巴巴提供的天池移动推荐数据集。该模型能够同时预测用户的购买概率和中间行为（收藏、加购物车）概率，通过多任务学习和复杂的特征工程提高预测精度。

## 数据集介绍

数据来源于天池移动推荐竞赛（tianchi_mobile_recommend_train_user.csv），包含以下字段：

- `user_id`：用户ID（已脱敏）
- `item_id`：商品ID（已脱敏）
- `behavior_type`：用户行为类型（1-浏览，2-收藏，3-加购物车，4-购买）
- `user_geohash`：用户位置空间标识（可为空）
- `item_category`：商品类目（已脱敏）
- `time`：行为时间（精确到小时）

训练数据包含了抽样用户在一个月时间（2014.11.18~2014.12.18）内的移动端行为数据，目标是预测这些用户在接下来一天（2014.12.19）对商品子集的购买行为。

## 特征工程

模型总共使用了615维特征，主要包括：

1. **商品ID的embedding**（128维）：捕捉商品的隐含特性
2. **用户ID的embedding**（128维）：表示用户的基本偏好
3. **商品类目的embedding**（64维）：反映商品类目信息
4. **时间特征**（11维）：
   - 星期几（7分类）→ 3维embedding
   - 工作日/周末（二分类）→ 1维
   - 小时（24分类）→ 5维embedding
   - 距今时间差值（归一化）→ 1维
   - 原始时间戳（归一化）→ 1维
5. **用户近期行为统计**（28维）：用户最近1-7天在各行为类型上的次数（7×4=28维）
6. **用户长期兴趣**（128维）：通过用户ID获取
7. **用户短期兴趣**（128维）：通过DIN（Deep Interest Network）计算，基于用户最近20条行为序列

## 模型架构

本项目采用了复杂的多任务学习模型，核心组件包括：

### 1. DIN（Deep Interest Network）

用于捕获用户的短期兴趣，通过注意力机制对用户历史行为序列进行加权，特别关注与当前商品相关的历史行为。

### 2. SE（Squeeze and Excitation）机制

对不同特征域进行自适应加权，具体步骤：
- 计算各特征域的平均值
- 通过两层全连接网络（FC+SiLU+FC+Sigmoid）生成特征域权重
- 将权重与各特征域进行点乘，实现特征域的自适应加权

### 3. PLE（Progressive Layered Extraction）主体网络

采用分层提取结构的多任务学习网络，包含：
- 任务特定专家网络：为每个任务（购买预测、中间行为预测）提供专门的参数
- 共享专家网络：在任务间共享知识
- 分层结构：随着层数增加，专家网络复杂度逐步提高
- 门控机制：动态选择和融合不同专家的输出

### 4. 任务头/塔（Tower）

每个预测任务使用独立的塔网络，基于Factorization Machine进行最终预测：
- y1:点击后发生其他行为（收藏，加入购物车）的概率
- y2:点击后直接购买的概率
- y3:发生其他行为会购买的概率
- 值得一提的是模型最终会输出两个值用于损失函数的训练: y1, y1*y3+(1-y1)*y2

## 训练过程

### 数据预处理

1. 时间特征处理：提取星期、小时等信息
2. 标签构建：根据behavior_type生成购买和中间行为的标签
3. 用户行为序列构建：为每个样本生成其对应的历史行为序列
4. 特征嵌入：为类别特征生成嵌入表示

### 训练策略

- **损失函数**：BCE(是否购买, y1) + BCE(是否发生收藏或加购物车, y2)
- **优化器**：Adam（学习率0.001）
- **批量大小**：训练128，验证256
- **训练轮次**：5轮
- **验证策略**：使用20%数据作为验证集
- **保存策略**：保存验证损失最低的模型

### 连续行为处理

特别关注了用户连续行为模式，尤其是收藏/加购物车后转化为购买的行为序列：
- 在数据集构建时标记连续行为模式
- 在模型分析部分专门统计了转化时间间隔分布
- 对不同前置行为（收藏vs加购物车）的转化效果进行了对比分析

## 模型评估

模型评估使用以下指标：
- **损失函数值**：BCE损失
- **准确率**：对购买和中间行为的预测准确率
- **特征重要性分析**：通过SE模块的权重分析不同特征域的贡献
- **行为模式分析**：分析用户行为转化的时间间隔和模式

## 代码结构

- `CVR_model.py`：核心模型实现，包含PLE网络架构
- `train.py`：完整训练流程，包括数据处理、模型训练和评估
- 主要组件：
  - ECommerceDataset：数据集类
  - SequenceGenerator：用户行为序列生成器
  - DIN：深度兴趣网络
  - SEBlock：特征域加权模块

## 环境要求

- Python 3.6+
- PyTorch 1.7+
- pandas, numpy, scikit-learn
- tqdm

## 使用方法

1. 准备数据：
```bash
mkdir -p DATA/train_user
# 将数据集放入DATA/train_user目录
```

2. 训练模型：
```bash
python train.py
```

3. 生成预测结果：
```bash
# 模型会自动生成submission.csv
```

## 模型特点

1. **多任务学习**：同时预测购买概率和中间行为概率，让模型学习更全面的用户行为
2. **特征域自适应加权**：通过SE机制动态调整不同特征域的重要性
3. **短期兴趣建模**：使用DIN捕获用户的短期兴趣偏好
4. **渐进式特征提取**：通过PLE结构逐层提取更抽象的特征表示
5. **连续行为建模**：特别关注用户行为序列中的转化模式



## 参考文献

1. Zhou, G., et al. (2018). Deep Interest Network for Click-Through Rate Prediction.
2. Hu, J., Shen, L., & Sun, G. (2018). Squeeze-and-Excitation Networks.
3. Tang, H., et al. (2020). Progressive Layered Extraction (PLE): A Novel Multi-Task Learning (MTL) Model for Personalized Recommendations.

## 联系方式

如有任何问题或建议，请通过1733429340@qq.com联系我。
